C51 COMPILER V9.55   F330_FLASHPRIMITIVES                                                  06/14/2018 23:18:53 PAGE 1   


C51 COMPILER V9.55, COMPILATION OF MODULE F330_FLASHPRIMITIVES
OBJECT MODULE PLACED IN .\Objects\F330_FlashPrimitives.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE F33x\F330_FlashPrimitives.c OPTIMIZE(9,SPEED) BROWSE INCDIR(.\driver;.\F
                    -33x;.\RFFC) DEBUG OBJECTEXTEND PRINT(.\Listings\F330_FlashPrimitives.lst) TABS(2) OBJECT(.\Objects\F330_FlashPrimitives.
                    -obj)

line level    source

   1          //-----------------------------------------------------------------------------
   2          // F330_FlashPrimitives.c
   3          //-----------------------------------------------------------------------------
   4          // Copyright 2004 Silicon Laboratories, Inc.
   5          //
   6          // This program contains several useful utilities for writing and updating
   7          // FLASH memory.
   8          //
   9          // AUTH: BW & GP
  10          // DATE: 21 JUL 04
  11          //
  12          // Target: C8051F33x
  13          // Tool chain: KEIL C51 7.06
  14          //
  15          // Release 1.0
  16          //
  17          
  18          //-----------------------------------------------------------------------------
  19          // Includes
  20          //-----------------------------------------------------------------------------
  21          
  22          #include "F330_FlashPrimitives.h"
  23          #include <c8051F330.h>
  24          
  25          //-----------------------------------------------------------------------------
  26          // Structures, Unions, Enumerations, and Type Definitions
  27          //-----------------------------------------------------------------------------
  28          
  29          //-----------------------------------------------------------------------------
  30          // Global Constants
  31          //-----------------------------------------------------------------------------
  32          
  33          //-----------------------------------------------------------------------------
  34          // Function Prototypes
  35          //-----------------------------------------------------------------------------
  36          
  37          // FLASH read/write/erase routines
  38          void FLASH_ByteWrite (FLADDR addr, char byte);
  39          unsigned char FLASH_ByteRead (FLADDR addr);
  40          void FLASH_PageErase (FLADDR addr);
  41          
  42          //-----------------------------------------------------------------------------
  43          // Global Variables
  44          //-----------------------------------------------------------------------------
  45          
  46          //-----------------------------------------------------------------------------
  47          // FLASH Routines
  48          //-----------------------------------------------------------------------------
  49          
  50          //-----------------------------------------------------------------------------
  51          // FLASH_ByteWrite
  52          //-----------------------------------------------------------------------------
  53          //
C51 COMPILER V9.55   F330_FLASHPRIMITIVES                                                  06/14/2018 23:18:53 PAGE 2   

  54          // This routine writes <byte> to the linear FLASH address <addr>.
  55          //
  56          // To do:
  57          //  -- optimize to skip 0xFF bytes
  58          //
  59          void FLASH_ByteWrite (FLADDR addr, char byte)
  60          {
  61   1         bit EA_SAVE = EA;                   // preserve EA
  62   1         char xdata * data pwrite;           // FLASH write pointer
  63   1      
  64   1         EA = 0;                             // disable interrupts
  65   1      
  66   1         // change clock speed to slow, then restore later
  67   1      
  68   1         VDM0CN = 0x80;                      // enable VDD monitor
  69   1      
  70   1      
  71   1         RSTSRC = 0x02;                      // enable VDD monitor as a reset source
  72   1      
  73   1         pwrite = (char xdata *) addr;
  74   1      
  75   1         FLKEY  = 0xA5;                      // Key Sequence 1
  76   1         FLKEY  = 0xF1;                      // Key Sequence 2
  77   1         PSCTL |= 0x01;                      // PSWE = 1
  78   1      
  79   1      
  80   1         VDM0CN = 0x80;                      // enable VDD monitor
  81   1      
  82   1      
  83   1         RSTSRC = 0x02;                      // enable VDD monitor as a reset source
  84   1      
  85   1         *pwrite = byte;                     // write the byte
  86   1      
  87   1         PSCTL &= ~0x01;                     // PSWE = 0
  88   1      
  89   1         EA = EA_SAVE;                       // restore interrupts
  90   1      }
  91          
  92          //-----------------------------------------------------------------------------
  93          // FLASH_ByteRead
  94          //-----------------------------------------------------------------------------
  95          //
  96          // This routine reads a <byte> from the linear FLASH address <addr>.
  97          //
  98          unsigned char FLASH_ByteRead (FLADDR addr)
  99          {
 100   1         bit EA_SAVE = EA;                   // preserve EA
 101   1         char code * data pread;             // FLASH read pointer
 102   1         unsigned char byte;
 103   1      
 104   1         EA = 0;                             // disable interrupts
 105   1      
 106   1         pread = (char code *) addr;
 107   1      
 108   1         byte = *pread;                      // read the byte
 109   1      
 110   1         EA = EA_SAVE;                       // restore interrupts
 111   1      
 112   1         return byte;
 113   1      }
 114          
 115          //-----------------------------------------------------------------------------
C51 COMPILER V9.55   F330_FLASHPRIMITIVES                                                  06/14/2018 23:18:53 PAGE 3   

 116          // FLASH_PageErase
 117          //-----------------------------------------------------------------------------
 118          //
 119          // This routine erases the FLASH page containing the linear FLASH address
 120          // <addr>.
 121          //
 122          void FLASH_PageErase (FLADDR addr)
 123          {
 124   1         bit EA_SAVE = EA;                   // preserve EA
 125   1         char xdata * data pwrite;           // FLASH write pointer
 126   1      
 127   1         EA = 0;                          // disable interrupts
 128   1         // change clock speed to slow, then restore later
 129   1      
 130   1         VDM0CN = 0x80;                      // enable VDD monitor
 131   1      
 132   1      
 133   1         RSTSRC = 0x02;                   // enable VDD monitor as a reset source
 134   1      
 135   1         pwrite = (char xdata *) addr;
 136   1      
 137   1         FLKEY  = 0xA5;                   // Key Sequence 1
 138   1         FLKEY  = 0xF1;                   // Key Sequence 2
 139   1         PSCTL |= 0x03;                   // PSWE = 1; PSEE = 1
 140   1      
 141   1      
 142   1         VDM0CN = 0x80;                      // enable VDD monitor
 143   1      
 144   1      
 145   1         RSTSRC = 0x02;                   // enable VDD monitor as a reset source
 146   1         *pwrite = 0;                     // initiate page erase
 147   1      
 148   1         PSCTL &= ~0x03;                  // PSWE = 0; PSEE = 0
 149   1      
 150   1         EA = EA_SAVE;                    // restore interrupts
 151   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =     89    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       3
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
